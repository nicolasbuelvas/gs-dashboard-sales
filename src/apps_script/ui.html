<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">
<base target="_top">
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
  body { font-family: Inter, Arial; margin: 0; padding: 16px; background: #f6f9fc; }
  header { display: flex; justify-content: space-between; align-items: center; }
  h1 { margin: 0; font-size: 18px; color: #1a73e8; }
  button { padding: 8px 12px; border: 0; border-radius: 6px; cursor: pointer; }
  .primary { background: #1a73e8; color: white; }
  .card { background: white; padding: 14px; margin-top: 14px; border-radius: 8px; }
  .chart { height: 320px; }
  #loader { font-size: 14px; margin-top: 6px; color: #555; }
</style>
</head>

<body>
<header>
  <h1>Sales Dashboard</h1>
  <div>
    <button class="primary" onclick="analyze()">Analyze</button>
    <button onclick="expand()">Expand</button>
  </div>
</header>

<div class="card">
  <div id="message">Press Analyze to load data.</div>
  <div id="loader" style="display:none;"></div>

  <div id="kpis" style="display:flex;gap:18px;margin-top:12px;"></div>

  <div style="text-align:right;margin-top:8px;">
    <button onclick="popChart()">Enlarge Chart</button>
  </div>

  <div id="chart" class="chart"></div>
</div>

<script>
google.charts.load('current', { packages:['corechart','line'] });

let lastChartData = null;

function expand() {
  google.script.run.withSuccessHandler(html => {
    const w = window.open('', '_blank');
    if (!w) { alert('Please enable pop-ups to open the window.'); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }).getFullscreenHTML();
}

function popChart() {
  if (!lastChartData) {
    alert("No chart available.");
    return;
  }
  const w = window.open("", "_blank", "width=600,height=500");
  if (!w) { alert("Please enable pop-ups to view the chart."); return; }

  w.document.write("<div id='chart' style='width:100%;height:100%;'></div>");
  w.document.close();

  google.charts.setOnLoadCallback(() => {
    const chart = new google.visualization.PieChart(w.document.getElementById('chart'));
    chart.draw(lastChartData, { pieHole: 0.4 });
  });
}

function analyze() {
  const msg = document.getElementById('message');
  const loader = document.getElementById('loader');

  msg.textContent = "Loading...";
  msg.style.display = "block";
  loader.style.display = "block";

  let sec = 0;
  const timer = setInterval(() => {
    sec++;
    loader.textContent = "Loading... (" + sec + "s)";
  }, 1000);

  google.script.run
    .withSuccessHandler(res => {
      if (res.error) {
        clearInterval(timer);
        msg.textContent = "Error: " + res.error;
        return;
      }

      if (!res.raw || !res.raw.length) {
        clearInterval(timer);
        msg.textContent = "No rows found.";
        return;
      }

      loader.textContent = "Loaded " + res.raw.length + " rows...";

      google.charts.setOnLoadCallback(() => {
        const data = normalizeClient(res.raw);

        if (!data.length) {
          clearInterval(timer);
          msg.textContent = "No valid rows after filtering.";
          return;
        }

        clearInterval(timer);
        msg.style.display = "none";
        loader.style.display = "none";

        render(data);
      });
    })
    .withFailureHandler(err => {
      clearInterval(timer);
      msg.textContent = "Error: " + err;
    })
    .getSalesData_vC();
}

function normalizeClient(raw) {
  const headers = raw[0].map(h => String(h || '').trim());
  const out = [];

  for (let i = 1; i < raw.length; i++) {
    const row = raw[i];
    const obj = {};
    headers.forEach((h, c) => obj[h] = row[c]);
    const sales = Number(String(obj.SALES||0).replace(/,/g,''));
    const order = Number(String(obj.ORDERNUMBER||0).replace(/\D/g,''));
    if (sales > 0 && order > 0) {
      obj.SALES = sales;
      obj.ORDERNUMBER = order;
      out.push(obj);
    }
  }
  return out;
}

function render(data) {
  const kpis = document.getElementById('kpis');

  const totalSales = data.reduce((s, r) => s + r.SALES, 0);
  const totalOrders = new Set(data.map(r => r.ORDERNUMBER)).size;

  kpis.innerHTML =
    "<div><b>Total Sales</b><div style='color:#1a73e8'>$" +
    totalSales.toLocaleString() +
    "</div></div>" +
    "<div><b>Total Orders</b><div>" +
    totalOrders +
    "</div></div>";

  const prod = {};
  data.forEach(r => prod[r.PRODUCTLINE] = (prod[r.PRODUCTLINE] || 0) + r.SALES);

  const arr = [['Product', 'Sales']];
  Object.keys(prod).forEach(k => arr.push([k, prod[k]]));

  lastChartData = google.visualization.arrayToDataTable(arr);

  const chart = new google.visualization.PieChart(document.getElementById('chart'));
  chart.draw(lastChartData, {
    title: 'Sales by Product Line',
    pieHole: 0.36,
    chartArea: { left: 20, top: 40, width: '80%', height: '75%' }
  });
}
</script>
</body>
</html>